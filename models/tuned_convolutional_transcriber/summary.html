
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tuned convolutional transcriber: training summary &#8212; Robot Rainfall Rescue</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Example image with transcriptions" href="compare.html" />
    <link rel="prev" title="Training script for a tuned convolutional transcriber model" href="training.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="compare.html" title="Example image with transcriptions"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="training.html" title="Training script for a tuned convolutional transcriber model"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RRR</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../atb2.html" >Direct transcription of a simplified training dataset</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">A tuned convolutional transcriber</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Tuned convolutional transcriber: training summary</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tuned-convolutional-transcriber-training-summary">
<h1>Tuned convolutional transcriber: training summary<a class="headerlink" href="#tuned-convolutional-transcriber-training-summary" title="Permalink to this headline">¶</a></h1>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="summary_video.html"><span class="doc">Video version</span></a></p>
</div>
<div class="figure align-center" id="id1" style="width: 95%">
<a class="reference internal image-reference" href="../../_images/summary_1000.png"><img alt="../../_images/summary_1000.png" src="../../_images/summary_1000.png" style="width: 95%;" /></a>
<p class="caption"><span class="caption-text">Validation summary after 10 epochs.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>On the left, Probability distribution of digits from the test dataset, as transcribed by the model, partitioned by correct answer (vertical axis) and transcribed value (horizontal axis). That is, the bottom left are digits that are really ‘0’ and are transcribed as ‘0’, bottom right - digits that are really ‘0’ but are transcribed as ‘9’, top left - digits that are really ‘9’ but are transcribed as ‘0’, …</p>
<p>Top right - Mean probability of correctness for digits from the test dataset, partitioned by location in the image.</p>
<p>Bottom right -  the most-likely digit in each location for a single test case . Digits in blue are correct, in red mistakes.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="code-to-make-the-figure">
<h2>Code to make the figure<a class="headerlink" href="#code-to-make-the-figure" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Make a single frame of the training progress video</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="kn">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/../&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">transcriberModel</span> <span class="kn">import</span> <span class="n">transcriberModel</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/../../dataset&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">makeDataset</span> <span class="kn">import</span> <span class="n">getImageDataset</span>
<span class="kn">from</span> <span class="nn">makeDataset</span> <span class="kn">import</span> <span class="n">getNumbersDataset</span>

<span class="kn">import</span> <span class="nn">argparse</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--epoch&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Epoch&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Set nimages to a small number for fast testing</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s2">&quot;--nimages&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;No of test cases to look at&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="c1"># Set pu the figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">19.20</span><span class="p">,</span> <span class="mf">10.80</span><span class="p">),</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">subplotpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tight_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">22</span><span class="p">})</span>
<span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="c1"># Paint the background white - why is this needed?</span>
<span class="n">ax_full</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
<span class="p">)</span>


<span class="c1"># Set up the model and load the weights at the chosen epoch</span>
<span class="n">transcriber1</span> <span class="o">=</span> <span class="n">transcriberModel</span><span class="p">()</span>
<span class="n">weights_dir</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Robot_Rainfall_Rescue/models/ATB2_retuned/&quot;</span> <span class="o">+</span> <span class="s2">&quot;Epoch_</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SCRATCH&quot;</span><span class="p">),</span>
    <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">load_status</span> <span class="o">=</span> <span class="n">transcriber1</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/ckpt&quot;</span> <span class="o">%</span> <span class="n">weights_dir</span><span class="p">)</span>
    <span class="n">load_status</span><span class="o">.</span><span class="n">assert_existing_objects_matched</span><span class="p">()</span>

<span class="n">transcriber2</span> <span class="o">=</span> <span class="n">transcriberModel</span><span class="p">()</span>
<span class="n">weights_dir</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Robot_Rainfall_Rescue/models/ATB2_retuned/&quot;</span> <span class="o">+</span> <span class="s2">&quot;Epoch_</span><span class="si">%04d</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SCRATCH&quot;</span><span class="p">),</span>
    <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span><span class="p">),</span>
<span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
    <span class="n">load_status</span> <span class="o">=</span> <span class="n">transcriber2</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/ckpt&quot;</span> <span class="o">%</span> <span class="n">weights_dir</span><span class="p">)</span>
    <span class="n">load_status</span><span class="o">.</span><span class="n">assert_existing_objects_matched</span><span class="p">()</span>

<span class="c1"># Make the probability matrix</span>
<span class="n">testImages</span> <span class="o">=</span> <span class="n">getImageDataset</span><span class="p">(</span><span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">nImages</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nimages</span><span class="p">)</span>
<span class="n">testNumbers</span> <span class="o">=</span> <span class="n">getNumbersDataset</span><span class="p">(</span><span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">nImages</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nimages</span><span class="p">)</span>
<span class="n">testData</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">zip</span><span class="p">((</span><span class="n">testImages</span><span class="p">,</span> <span class="n">testNumbers</span><span class="p">))</span>
<span class="c1"># Need the size of the dataset</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nimages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">nimages</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">testData</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">nimages</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">nimages</span>

<span class="n">count</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">pmatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">dcount</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">plmatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">436</span><span class="p">))</span>
<span class="n">origN</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">encN</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">testCase</span> <span class="ow">in</span> <span class="n">testData</span><span class="p">:</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">testCase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">testCase</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">==</span> <span class="mi">50</span> <span class="ow">or</span> <span class="n">dcount</span> <span class="o">/</span> <span class="n">nimages</span> <span class="o">&lt;=</span> <span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">%</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">transcriber1</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">encoded</span> <span class="o">=</span> <span class="n">transcriber2</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Save the first case for ploting</span>
    <span class="k">if</span> <span class="n">origN</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">origN</span> <span class="o">=</span> <span class="n">orig</span>
        <span class="n">encN</span> <span class="o">=</span> <span class="n">encoded</span>
    <span class="c1"># PvP matrix</span>
    <span class="k">for</span> <span class="n">tidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">orig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">originalDigit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orig</span><span class="p">[</span><span class="n">tidx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dgProbabilities</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tidx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">pmatrix</span><span class="p">[</span><span class="n">originalDigit</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">dgProbabilities</span>
        <span class="n">count</span><span class="p">[</span><span class="n">originalDigit</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Place matrix</span>
    <span class="k">for</span> <span class="n">tidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">436</span><span class="p">):</span>
        <span class="n">originalDigit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orig</span><span class="p">[</span><span class="n">tidx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dgProbabilities</span> <span class="o">=</span> <span class="n">encoded</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tidx</span><span class="p">,</span> <span class="n">originalDigit</span><span class="p">]</span>
        <span class="n">plmatrix</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dgProbabilities</span>

<span class="n">pmatrix</span> <span class="o">/=</span> <span class="n">count</span>
<span class="n">plmatrix</span> <span class="o">/=</span> <span class="n">nimages</span>


<span class="c1"># Plot the probability matrix</span>

<span class="c1"># Plot a bar chart of transcription probabilities for a single digit</span>
<span class="k">def</span> <span class="nf">plot1</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="k">if</span> <span class="n">td</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">fc</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">td</span> <span class="o">-</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">td</span> <span class="o">-</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">pmatrix</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">td</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">fc</span>
            <span class="p">)</span>
        <span class="p">)</span>


<span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">ax_digit</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span> <span class="o">+</span> <span class="p">(</span><span class="n">td</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">])</span>
    <span class="n">ax_digit</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">])</span>
    <span class="n">ax_digit</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ax_digit</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax_digit</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">td</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax_digit</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax_digit</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="c1"># ax_digit.set_xlabel(&quot;Transcribed choice&quot;)</span>
    <span class="n">ax_digit</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([])</span>
    <span class="n">ax_digit</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%1d</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="n">td</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plot1</span><span class="p">(</span><span class="n">ax_digit</span><span class="p">,</span> <span class="n">td</span><span class="p">)</span>

<span class="c1"># plot the place distribution</span>
<span class="n">ax_full</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">imp</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;xscale&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;yscale&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;xshift&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># pixels, +ve right</span>
    <span class="s2">&quot;yshift&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># pixels, +ve up</span>
    <span class="s2">&quot;rotate&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># degrees clockwise</span>
    <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="s2">&quot;bgcolour&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="s2">&quot;fgcolour&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
    <span class="s2">&quot;yearHeight&quot;</span><span class="p">:</span> <span class="mf">0.066</span><span class="p">,</span>  <span class="c1"># Fractional height of year row</span>
    <span class="s2">&quot;totalsHeight&quot;</span><span class="p">:</span> <span class="mf">0.105</span><span class="p">,</span>  <span class="c1"># Fractional height of totals row</span>
    <span class="s2">&quot;monthsWidth&quot;</span><span class="p">:</span> <span class="mf">0.137</span><span class="p">,</span>  <span class="c1"># Fractional width of months row</span>
    <span class="s2">&quot;meansWidth&quot;</span><span class="p">:</span> <span class="mf">0.107</span><span class="p">,</span>  <span class="c1"># Fractional width of means row</span>
    <span class="s2">&quot;fontSize&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">1941</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Box with the data in</span>
<span class="n">topLeft</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.07</span> <span class="o">+</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;xshift&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">768</span><span class="p">,</span> <span class="mf">0.725</span> <span class="o">+</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yshift&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">topRight</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mf">0.93</span> <span class="o">+</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;xshift&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">768</span> <span class="o">+</span> <span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;xscale&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.86</span><span class="p">,</span>
    <span class="mf">0.725</span> <span class="o">+</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yshift&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">bottomLeft</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.07</span> <span class="o">+</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;xshift&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">768</span><span class="p">,</span> <span class="mf">0.325</span> <span class="o">+</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yshift&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span>
<span class="n">bottomRight</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mf">0.93</span> <span class="o">+</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;xshift&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">768</span> <span class="o">+</span> <span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;xscale&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.86</span><span class="p">,</span>
    <span class="mf">0.325</span> <span class="o">+</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yshift&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">-</span> <span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yscale&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">topLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">topRight</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bottomRight</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bottomLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">topLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">topLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">topRight</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bottomRight</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bottomLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">topLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">topAt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># x is fraction along top line</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">topRight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">topLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">),</span>
        <span class="n">topRight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">topLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">bottomAt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">bottomRight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">bottomLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">),</span>
        <span class="n">bottomRight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">bottomLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">leftAt</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>  <span class="c1"># y is fraction of way from bottom to top</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">topLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bottomLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span>
        <span class="n">topLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bottomLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">rightAt</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">topRight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bottomRight</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span>
        <span class="n">topRight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">bottomRight</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span>
    <span class="p">)</span>


<span class="c1"># Draw the grid</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">])</span>
<span class="n">rgt</span> <span class="o">=</span> <span class="n">rightAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">lft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rgt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rgt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
<span class="n">rgt</span> <span class="o">=</span> <span class="n">rightAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">lft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rgt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rgt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span>
<span class="n">bm</span> <span class="o">=</span> <span class="n">bottomAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">])</span>
<span class="n">bm</span> <span class="o">=</span> <span class="n">bottomAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">])</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">yrl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">yrl</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">bm</span> <span class="o">=</span> <span class="n">bottomAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax_full</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
        <span class="n">Line2D</span><span class="p">(</span>
            <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="c1"># Add the fixed text</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;Year&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;Means&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax_full</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;Totals&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">months</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;January&quot;</span><span class="p">,</span>
    <span class="s2">&quot;February&quot;</span><span class="p">,</span>
    <span class="s2">&quot;March&quot;</span><span class="p">,</span>
    <span class="s2">&quot;April&quot;</span><span class="p">,</span>
    <span class="s2">&quot;May&quot;</span><span class="p">,</span>
    <span class="s2">&quot;June&quot;</span><span class="p">,</span>
    <span class="s2">&quot;July&quot;</span><span class="p">,</span>
    <span class="s2">&quot;August&quot;</span><span class="p">,</span>
    <span class="s2">&quot;September&quot;</span><span class="p">,</span>
    <span class="s2">&quot;October&quot;</span><span class="p">,</span>
    <span class="s2">&quot;November&quot;</span><span class="p">,</span>
    <span class="s2">&quot;December&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)):</span>
    <span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span>
        <span class="mf">1.0</span>
        <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span>
        <span class="o">-</span> <span class="p">(</span><span class="n">mdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
        <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">ax_full</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">months</span><span class="p">[</span><span class="n">mdx</span><span class="p">],</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ydx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">ydx</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax_full</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ydx</span><span class="p">),</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Add the transcribed numbers</span>
<span class="n">tidx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">yri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">yri</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
        <span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span>
            <span class="mf">1.0</span>
            <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="p">(</span><span class="n">mni</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
            <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">dgi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">ax_full</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">dgi</span> <span class="o">*</span> <span class="mf">0.015</span> <span class="o">-</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span>
                    <span class="mf">0.01</span><span class="p">,</span>
                    <span class="mf">0.02</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ax_full</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">dgi</span> <span class="o">*</span> <span class="mf">0.015</span> <span class="o">-</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span>
                    <span class="mf">0.01</span><span class="p">,</span>
                    <span class="mf">0.02</span> <span class="o">*</span> <span class="n">plmatrix</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span>
                    <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">tidx</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1"># Add the monthly means</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span>
        <span class="mf">1.0</span>
        <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span>
        <span class="o">-</span> <span class="p">(</span><span class="n">mni</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
        <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">dgi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">ax_full</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">dgi</span> <span class="o">*</span> <span class="mf">0.015</span> <span class="o">-</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span>
                <span class="mf">0.01</span><span class="p">,</span>
                <span class="mf">0.02</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ax_full</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">dgi</span> <span class="o">*</span> <span class="mf">0.015</span> <span class="o">-</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span>
                <span class="mf">0.01</span><span class="p">,</span>
                <span class="mf">0.02</span> <span class="o">*</span> <span class="n">plmatrix</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">tidx</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1"># Add the annual totals</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">yri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">yri</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">inr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">dgi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">ax_full</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.0225</span> <span class="o">+</span> <span class="n">dgi</span> <span class="o">*</span> <span class="mf">0.015</span> <span class="o">-</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span>
                <span class="mf">0.01</span><span class="p">,</span>
                <span class="mf">0.02</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ax_full</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.0225</span> <span class="o">+</span> <span class="n">dgi</span> <span class="o">*</span> <span class="mf">0.015</span> <span class="o">-</span> <span class="mf">0.005</span><span class="p">,</span> <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">),</span>
                <span class="mf">0.01</span><span class="p">,</span>
                <span class="mf">0.02</span> <span class="o">*</span> <span class="n">plmatrix</span><span class="p">[</span><span class="n">tidx</span><span class="p">],</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">tidx</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># plot the single example</span>
<span class="n">ax_encoded</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="n">ax_encoded</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">topLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">topRight</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bottomRight</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bottomLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">topLeft</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">topLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">topRight</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bottomRight</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bottomLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">topLeft</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Draw the grid</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">])</span>
<span class="n">rgt</span> <span class="o">=</span> <span class="n">rightAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">])</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">lft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rgt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rgt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
<span class="n">rgt</span> <span class="o">=</span> <span class="n">rightAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">lft</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rgt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rgt</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span>
<span class="n">bm</span> <span class="o">=</span> <span class="n">bottomAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">])</span>
<span class="n">bm</span> <span class="o">=</span> <span class="n">bottomAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">])</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
    <span class="n">Line2D</span><span class="p">(</span>
        <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">yrl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">yrl</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">bm</span> <span class="o">=</span> <span class="n">bottomAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax_encoded</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span>
        <span class="n">Line2D</span><span class="p">(</span>
            <span class="n">xdata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">ydata</span><span class="o">=</span><span class="p">(</span><span class="n">tp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">bm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fgcolour&quot;</span><span class="p">],</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="c1"># Add the fixed text</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;Year&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;Means&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax_encoded</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="s2">&quot;Totals&quot;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">months</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;January&quot;</span><span class="p">,</span>
    <span class="s2">&quot;February&quot;</span><span class="p">,</span>
    <span class="s2">&quot;March&quot;</span><span class="p">,</span>
    <span class="s2">&quot;April&quot;</span><span class="p">,</span>
    <span class="s2">&quot;May&quot;</span><span class="p">,</span>
    <span class="s2">&quot;June&quot;</span><span class="p">,</span>
    <span class="s2">&quot;July&quot;</span><span class="p">,</span>
    <span class="s2">&quot;August&quot;</span><span class="p">,</span>
    <span class="s2">&quot;September&quot;</span><span class="p">,</span>
    <span class="s2">&quot;October&quot;</span><span class="p">,</span>
    <span class="s2">&quot;November&quot;</span><span class="p">,</span>
    <span class="s2">&quot;December&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mdx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)):</span>
    <span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span>
        <span class="mf">1.0</span>
        <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span>
        <span class="o">-</span> <span class="p">(</span><span class="n">mdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
        <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">ax_encoded</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">months</span><span class="p">[</span><span class="n">mdx</span><span class="p">],</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ydx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">ydx</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ax_encoded</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ydx</span><span class="p">),</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Add the transcribed numbers</span>
<span class="n">orig</span> <span class="o">=</span> <span class="n">origN</span>
<span class="n">trnb</span> <span class="o">=</span> <span class="n">encN</span>
<span class="n">tidx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">yri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">yri</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
        <span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span>
            <span class="mf">1.0</span>
            <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="p">(</span><span class="n">mni</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
            <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">dgi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">originalDigit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orig</span><span class="p">[</span><span class="n">tidx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dgProbabilities</span> <span class="o">=</span> <span class="n">trnb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tidx</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">bestTranscribed</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">dgProbabilities</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">dgProbabilities</span><span class="p">)</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">colour</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
            <span class="k">if</span> <span class="n">bestTranscribed</span> <span class="o">==</span> <span class="n">originalDigit</span><span class="p">:</span>
                <span class="n">colour</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
            <span class="n">ax_encoded</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">dgi</span> <span class="o">*</span> <span class="mf">0.015</span><span class="p">,</span>
                <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;</span><span class="si">%1d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bestTranscribed</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">tidx</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1"># Add the monthly means</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span>
        <span class="mf">1.0</span>
        <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span>
        <span class="o">-</span> <span class="p">(</span><span class="n">mni</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;yearHeight&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">])</span>
        <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">dgi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">originalDigit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orig</span><span class="p">[</span><span class="n">tidx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dgProbabilities</span> <span class="o">=</span> <span class="n">trnb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tidx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">bestTranscribed</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dgProbabilities</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">dgProbabilities</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="k">if</span> <span class="n">bestTranscribed</span> <span class="o">==</span> <span class="n">originalDigit</span><span class="p">:</span>
            <span class="n">colour</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="n">dgi</span> <span class="o">*</span> <span class="mf">0.015</span><span class="p">,</span>
            <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;</span><span class="si">%1d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bestTranscribed</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
            <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">tidx</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1"># Add the annual totals</span>
<span class="n">lft</span> <span class="o">=</span> <span class="n">leftAt</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;totalsHeight&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">yri</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">yri</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;meansWidth&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">imp</span><span class="p">[</span><span class="s2">&quot;monthsWidth&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10</span>
    <span class="p">)</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">topAt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">inr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">dgi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">originalDigit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orig</span><span class="p">[</span><span class="n">tidx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dgProbabilities</span> <span class="o">=</span> <span class="n">trnb</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">tidx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">bestTranscribed</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dgProbabilities</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">dgProbabilities</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">colour</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
        <span class="k">if</span> <span class="n">bestTranscribed</span> <span class="o">==</span> <span class="n">originalDigit</span><span class="p">:</span>
            <span class="n">colour</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
        <span class="n">ax_encoded</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">tp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.0225</span> <span class="o">+</span> <span class="n">dgi</span> <span class="o">*</span> <span class="mf">0.015</span><span class="p">,</span>
            <span class="n">lft</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;</span><span class="si">%1d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bestTranscribed</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">imp</span><span class="p">[</span><span class="s2">&quot;fontSize&quot;</span><span class="p">],</span>
            <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">tidx</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Render the figure as a png</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/Robot_Rainfall_Rescue/models/ATB2_retuned/video/</span><span class="si">%04d</span><span class="s2">.png&quot;</span>
    <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;SCRATCH&quot;</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">epoch</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/RRR_logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rainfall_rescue_data/index.html">Getting the images to transcribe</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../training_data/itp.html">Preparing a transfer dataset for training</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../atb2.html">Direct transcription of the simplified training dataset</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../deep_convolutional_transcriber/index.html">A deep convolutional transcriber</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">A tuned convolutional transcriber</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../layout.html">Modelling the page layout</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../how_to.html">How to reproduce or extend this work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Authors and acknowledgements</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/Robot_Rainfall_Rescue">Get the code</a></h3>

<ul>
<li><a href="https://github.com/philip-brohan/Robot_Rainfall_Rescue"
           rel="nofollow">Github repository</a></li>
<li><a href="https://github.com/philip-brohan/Robot_Rainfall_Rescue/archive/master.zip"
           rel="nofollow">Zip file</a></li>
</ul>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/Robot_Rainfall_Rescue/issues/new">raise an issue</a><br>or <a href="mailto://philip.brohan@metoffice.gov.uk">contact Philip</a>.
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="compare.html" title="Example image with transcriptions"
             >next</a></li>
        <li class="right" >
          <a href="training.html" title="Training script for a tuned convolutional transcriber model"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">RRR</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../atb2.html" >Direct transcription of a simplified training dataset</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >A tuned convolutional transcriber</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Tuned convolutional transcriber: training summary</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>